#!/bin/sh

# Git prompt module for Clifm
# License: GPL3
# Written by L. Abramovich

tmp="$(git -c color.status=false status -sb 2>/dev/null | sed -n 1p | cut -d'/' -f2)"

[ -z "$tmp" ] && exit 1

branch="$(echo "$tmp" | cut -d' ' -f1)"

case "$tmp" in
	*"["*) ahead_behind="$(echo "$tmp" | cut -d' ' -f2-3 | tr -d '[]')" ;;
esac

status=""

for i in $(git status --porcelain | cut -c1-3 | uniq); do
	case "$i" in
		".") status="${status}\e[36m+" ;;
		"D"*) status="${status}\e[31mD" ;;
		"M"*) status="${status}\e[32mM" ;;
		"R"*) status="${status}\e[35mR" ;;
		"U"*) status="${status}\e[33mU" ;;
		"A"*) status="${status}\e[32mA" ;;
		"??"*) status="${status}\e[31m?" ;;
    esac
done

# FIXME: The POSIX version of echo does not support flags
if [ -n "$ahead_behind" ]; then
	if [ "$(echo "$ahead_behind" | cut -b1)" = "a" ]; then
		color="\e[0;32m"
	else
		color="\e[0;31m"
	fi
	echo -ne "(\e[35m$branch\e[0m\e[2;37m|$color$ahead_behind\e[0m"
else
	echo -ne "(\e[35m$branch\e[0m"
fi

if [ -n "$status" ]; then
	echo -e "\e[2;37m|\e[0m${status}\e[0m)"
else
	echo -e ")\n"
fi

exit 0
